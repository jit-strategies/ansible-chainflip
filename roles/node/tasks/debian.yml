- name: Install dependencies
  ansible.builtin.apt:
    name: "{{ item }}"
    state: present
    update_cache: true
  with_items:
    - dirmngr

- name: Add Chainflip apt key
  ansible.builtin.apt_key:
    keyserver: keyserver.ubuntu.com
    id: "{{ chainflip_apt_repository_key_id }}"

- name: Add apt repository into sources list
  ansible.builtin.apt_repository:
    repo: >-
      deb {{ chainflip_apt_repository_url }}/{{ chainflip_release }}/{{ ansible_distribution_release }} {{ ansible_distribution_release }} main
    state: present

- name: Debug | Apt Repo
  ansible.builtin.debug:
    msg: "Using APT repo: {{ chainflip_apt_repository_url }}/{{ chainflip_release }}/{{ ansible_distribution_release }} {{ ansible_distribution_release }} main"
  run_once: true

- name: Install node and cli packages
  with_items: [chainflip-node, chainflip-cli]
  ansible.builtin.apt:
    name: "{{ item }}"
    state: present
    update_cache: true
  register: node_installed
  until: node_installed is successful
  delay: 5
  retries: 3

- name: Install engine package
  ansible.builtin.apt:
    name: chainflip-engine
    state: present
    update_cache: true
  register: engine_installed
  until: engine_installed is successful
  when:
    - engine_enabled
  delay: 5
  retries: 3

- name: Generate new keys with cli
  no_log: true
  register: validator_keys
  ansible.builtin.command:
    cmd: chainflip-cli generate-keys --json
  changed_when: false
  when:
    - not generate_keys_from_seed

- name: Generate keys from seed phrase
  when: generate_keys_from_seed
  block:
    - name: Seed phrase prompt
      ansible.builtin.pause:
        prompt: "Enter the 12-word seed phrase:"
        echo: false
      no_log: true
      register: seed_phrase_prompt

    - name: Generate new keys with provided seed phrase
      no_log: true
      register: validator_keys_from_seed
      ansible.builtin.command:
        cmd: chainflip-cli generate-keys --json --seed-phrase "{{ seed_phrase_prompt.user_input }}"
      changed_when: false

    - name: Save keys from seed
      ansible.builtin.set_fact:
        validator_keys: "{{ validator_keys_from_seed }}"
      no_log: true

- name: Save generated address as fact
  ansible.builtin.set_fact:
    generated_ss58Address: "{{ (validator_keys.stdout | from_json).signing_account_id }}"
  changed_when: false
